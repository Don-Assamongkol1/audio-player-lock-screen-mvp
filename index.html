<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Hello World Audio Test</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      :root {
        color-scheme: light dark;
        --bg: #050509;
        --bg-card: #111827;
        --accent: #3b82f6;
        --accent-soft: rgba(59, 130, 246, 0.1);
        --accent-strong: rgba(59, 130, 246, 0.25);
        --text: #e5e7eb;
        --text-muted: #9ca3af;
        --border-subtle: #1f2937;
      }

      * {
        box-sizing: border-box;
      }

      body {
        margin: 0;
        min-height: 100vh;
        display: flex;
        align-items: center;
        justify-content: center;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text",
          "Helvetica Neue", Arial, sans-serif;
        background: radial-gradient(circle at top, #111827 0, var(--bg) 45%);
        color: var(--text);
      }

      .shell {
        width: 100%;
        max-width: 520px;
        padding: 20px;
      }

      .card {
        background: radial-gradient(circle at top left, #111827, var(--bg-card));
        border-radius: 24px;
        padding: 20px 20px 16px;
        box-shadow:
          0 24px 60px rgba(15, 23, 42, 0.85),
          0 0 0 1px rgba(148, 163, 184, 0.1);
        border: 1px solid var(--border-subtle);
        position: relative;
        overflow: hidden;
      }

      .card::before {
        content: "";
        position: absolute;
        inset: -40%;
        background:
          radial-gradient(circle at 0 0, var(--accent-strong), transparent 50%),
          radial-gradient(circle at 100% 0, rgba(236, 72, 153, 0.35), transparent 55%);
        opacity: 0.4;
        mix-blend-mode: screen;
        pointer-events: none;
      }

      .card-inner {
        position: relative;
        z-index: 1;
      }

      h1 {
        font-size: 1.2rem;
        margin: 0 0 4px;
        letter-spacing: 0.03em;
        text-transform: uppercase;
        color: var(--text-muted);
      }

      .title {
        font-size: 1.4rem;
        font-weight: 600;
        margin-bottom: 4px;
      }

      .subtitle {
        font-size: 0.9rem;
        color: var(--text-muted);
        margin-bottom: 16px;
      }

      .pill {
        display: inline-flex;
        align-items: center;
        gap: 6px;
        padding: 4px 10px;
        border-radius: 999px;
        background: rgba(15, 23, 42, 0.95);
        border: 1px solid rgba(148, 163, 184, 0.35);
        font-size: 0.7rem;
        text-transform: uppercase;
        letter-spacing: 0.12em;
        color: var(--text-muted);
        margin-bottom: 8px;
      }

      .pill-dot {
        width: 7px;
        height: 7px;
        border-radius: 999px;
        background: #22c55e;
        box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.35);
      }

      .player {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 12px 12px 10px;
        border-radius: 18px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(148, 163, 184, 0.3);
        margin-bottom: 10px;
      }

      .cover {
        width: 52px;
        height: 52px;
        border-radius: 16px;
        background:
          conic-gradient(
            from 140deg,
            #3b82f6,
            #a855f7,
            #ec4899,
            #f97316,
            #3b82f6
          );
        position: relative;
        overflow: hidden;
        flex-shrink: 0;
      }

      .cover::after {
        content: "";
        position: absolute;
        inset: 18%;
        border-radius: inherit;
        background: radial-gradient(circle at 30% 20%, #0f172a, #020617);
      }

      .meta {
        flex: 1;
        min-width: 0;
      }

      .track-title {
        font-size: 0.95rem;
        font-weight: 500;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .track-artist {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 2px;
      }

      .track-status {
        font-size: 0.75rem;
        color: var(--text-muted);
        margin-top: 3px;
      }

      .play-toggle {
        border: none;
        outline: none;
        width: 44px;
        height: 44px;
        border-radius: 999px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        background: radial-gradient(circle at 30% 0, #60a5fa, #2563eb);
        box-shadow:
          0 12px 25px rgba(37, 99, 235, 0.7),
          0 0 0 1px rgba(59, 130, 246, 0.6);
        color: white;
        cursor: pointer;
        flex-shrink: 0;
        transition: transform 120ms ease, box-shadow 120ms ease, filter 120ms ease;
      }

      .play-toggle:hover {
        transform: translateY(-1px);
        filter: brightness(1.05);
        box-shadow:
          0 14px 32px rgba(37, 99, 235, 0.8),
          0 0 0 1px rgba(96, 165, 250, 0.8);
      }

      .play-toggle:active {
        transform: translateY(0);
        box-shadow:
          0 6px 16px rgba(37, 99, 235, 0.75),
          0 0 0 1px rgba(37, 99, 235, 0.9);
      }

      .icon {
        width: 18px;
        height: 18px;
      }

      .progress-row {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.7rem;
        color: var(--text-muted);
        margin-top: 4px;
      }

      .time {
        min-width: 32px;
      }

      .bar {
        position: relative;
        flex: 1;
        height: 5px;
        border-radius: 999px;
        background: linear-gradient(to right, #111827, #020617);
        overflow: hidden;
      }

      .bar-fill {
        position: absolute;
        inset: 0;
        transform-origin: left center;
        transform: scaleX(0);
        background: linear-gradient(90deg, #3b82f6, #ec4899);
      }

      .note {
        font-size: 0.8rem;
        color: var(--text-muted);
        margin-top: 10px;
        line-height: 1.4;
      }

      .note strong {
        color: var(--text);
      }

      .note code {
        font-size: 0.75rem;
        padding: 1px 4px;
        border-radius: 4px;
        background: rgba(15, 23, 42, 0.9);
        border: 1px solid rgba(55, 65, 81, 0.9);
      }

      @media (max-width: 480px) {
        .card {
          padding: 16px;
          border-radius: 18px;
        }

        .player {
          padding: 10px;
        }
      }
    </style>
  </head>
  <body>
    <div class="shell">
      <div class="card">
        <div class="card-inner">
          <div class="pill">
            <span class="pill-dot"></span>
            Local network audio test
          </div>
          <h1>Hello World Audio</h1>
          <div class="title">iPhone Lock Screen Playback</div>
          <div class="subtitle">
            Tap play on your phone, then lock the screen. Audio should keep
            playing and appear in the Now Playing widget.
          </div>

          <div class="player">
            <div class="cover" aria-hidden="true"></div>

            <div class="meta">
              <div class="track-title">Hello (demo)</div>
              <div class="track-artist">Public domain pronunciation sample</div>
              <div class="track-status" id="status">Idle</div>

              <div class="progress-row">
                <span class="time" id="currentTime">0:00</span>
                <div class="bar">
                  <div class="bar-fill" id="barFill"></div>
                </div>
                <span class="time" id="duration">0:00</span>
              </div>
            </div>

            <button class="play-toggle" id="playToggle" aria-label="Play">
              <svg
                class="icon"
                viewBox="0 0 24 24"
                fill="none"
                xmlns="http://www.w3.org/2000/svg"
              >
                <path
                  id="playIcon"
                  d="M8 5.5V18.5L18 12L8 5.5Z"
                  fill="currentColor"
                />
              </svg>
            </button>
          </div>

          <p class="note">
            <strong>How to test on your iPhone:</strong>
            connect your phone and this Mac to the same Wiâ€‘Fi, run a simple
            server (for example
            <code>python3 -m http.server 8000</code> in this folder), then on
            your iPhone open Safari and visit
            <code>http://&lt;your-mac-ip&gt;:8000/</code>. Tap the play button,
            then press the power button to lock the screen. The audio should
            continue playing from the lock screen.
          </p>
        </div>
      </div>
    </div>

    <!-- Simple audio element; source is a tiny public-domain "hello" recording -->
    <audio
      id="helloAudio"
      preload="auto"
      src="https://upload.wikimedia.org/wikipedia/commons/5/52/En-us-hello.ogg"
    ></audio>

    <script>
      const audio = document.getElementById("helloAudio");
      const playToggle = document.getElementById("playToggle");
      const playIcon = document.getElementById("playIcon");
      const statusEl = document.getElementById("status");
      const currentTimeEl = document.getElementById("currentTime");
      const durationEl = document.getElementById("duration");
      const barFill = document.getElementById("barFill");

      // We want the clip to effectively be a 20s loop.
      // The underlying audio is short, so we loop it and track a virtual
      // 20-second "session" timer for the UI and auto-stop.
      const TARGET_DURATION = 20; // seconds
      let virtualElapsed = 0;
      let playStartedAt = null;
      let progressRAF = null;

      // Ensure the browser loops the raw audio clip
      audio.loop = true;

      function formatTime(seconds) {
        if (!isFinite(seconds)) return "0:00";
        const m = Math.floor(seconds / 60);
        const s = Math.floor(seconds % 60)
          .toString()
          .padStart(2, "0");
        return `${m}:${s}`;
      }

      function getVirtualElapsed() {
        if (playStartedAt === null) return Math.min(virtualElapsed, TARGET_DURATION);
        const now = performance.now() / 1000;
        return Math.min(TARGET_DURATION, virtualElapsed + (now - playStartedAt));
      }

      function setPlayingUI(isPlaying) {
        if (isPlaying) {
          playIcon.setAttribute(
            "d",
            "M9 6.5C8.44772 6.5 8 6.94772 8 7.5V16.5C8 17.0523 8.44772 17.5 9 17.5H10C10.5523 17.5 11 17.0523 11 16.5V7.5C11 6.94772 10.5523 6.5 10 6.5H9ZM14 6.5C13.4477 6.5 13 6.94772 13 7.5V16.5C13 17.0523 13.4477 17.5 14 17.5H15C15.5523 17.5 16 17.0523 16 16.5V7.5C16 6.94772 15.5523 6.5 15 6.5H14Z"
          );
          statusEl.textContent = "Playing on this device";
          playToggle.setAttribute("aria-label", "Pause");
        } else {
          playIcon.setAttribute("d", "M8 5.5V18.5L18 12L8 5.5Z");
          statusEl.textContent = "Paused";
          playToggle.setAttribute("aria-label", "Play");
        }
      }

      function updateProgress() {
        const elapsed = getVirtualElapsed();
        currentTimeEl.textContent = formatTime(elapsed);
        durationEl.textContent = formatTime(TARGET_DURATION);
        const ratio = TARGET_DURATION ? Math.min(elapsed / TARGET_DURATION, 1) : 0;
        barFill.style.transform = `scaleX(${ratio})`;
      }

      function startProgressLoop() {
        if (progressRAF !== null) return;
        const loop = () => {
          const elapsed = getVirtualElapsed();
          updateProgress();
          if (elapsed >= TARGET_DURATION) {
            // Stop playback after we've virtually reached 20 seconds.
            audio.pause();
            audio.currentTime = 0;
            virtualElapsed = 0;
            playStartedAt = null;
            progressRAF = null;
            setPlayingUI(false);
            updateProgress();
            return;
          }
          progressRAF = requestAnimationFrame(loop);
        };
        progressRAF = requestAnimationFrame(loop);
      }

      function stopProgressLoop() {
        if (progressRAF !== null) {
          cancelAnimationFrame(progressRAF);
          progressRAF = null;
        }
      }

      playToggle.addEventListener("click", async () => {
        try {
          if (audio.paused) {
            await audio.play();
          } else {
            audio.pause();
          }
        } catch (err) {
          console.error("Playback failed:", err);
          statusEl.textContent = "Tap again to allow audio";
        }
      });

      audio.addEventListener("play", () => {
        if (getVirtualElapsed() >= TARGET_DURATION) {
          // If we somehow resumed past 20s, reset.
          virtualElapsed = 0;
        }
        if (playStartedAt === null) {
          playStartedAt = performance.now() / 1000;
        }
        setPlayingUI(true);
        startProgressLoop();
      });

      audio.addEventListener("pause", () => {
        // Capture elapsed time up to the moment of pause.
        virtualElapsed = getVirtualElapsed();
        playStartedAt = null;
        setPlayingUI(false);
        stopProgressLoop();
      });

      // Initialize progress display to 0 / 0:20
      updateProgress();

      // Optional: advertise metadata to iOS lock screen / Control Center
      if ("mediaSession" in navigator) {
        navigator.mediaSession.metadata = new MediaMetadata({
          title: "Hello (demo)",
          artist: "Public domain sample",
          album: "Hello World Test",
          artwork: [
            {
              src:
                "https://upload.wikimedia.org/wikipedia/commons/thumb/4/4e/Ambox_content.png/256px-Ambox_content.png",
              sizes: "256x256",
              type: "image/png",
            },
          ],
        });

        navigator.mediaSession.setActionHandler("play", async () => {
          try {
            await audio.play();
          } catch (e) {
            console.error(e);
          }
        });
        navigator.mediaSession.setActionHandler("pause", () => audio.pause());
      }
    </script>
  </body>
</html>

